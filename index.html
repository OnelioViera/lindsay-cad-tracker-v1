<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lindsay Precast Drafter Workflow Tracker</title>
    <script
      crossorigin
      src="https://unpkg.com/react@18/umd/react.production.min.js"
    ></script>
    <script
      crossorigin
      src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translate(-50%, -50%) scale(0.9);
        }
        to {
          opacity: 1;
          transform: translate(-50%, -50%) scale(1);
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.3s ease-out;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      // API Base URL - works in both development and production
      const API_BASE = window.location.hostname === 'localhost' 
        ? 'http://localhost:3001/api'
        : '/api';

      // API Helper Functions
      const api = {
        // Projects
        async getProjects() {
          const response = await fetch(`${API_BASE}/projects`);
          if (!response.ok) throw new Error('Failed to fetch projects');
          return response.json();
        },
        async createProject(project) {
          const response = await fetch(`${API_BASE}/projects`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(project)
          });
          if (!response.ok) throw new Error('Failed to create project');
          return response.json();
        },
        async updateProject(id, project) {
          const response = await fetch(`${API_BASE}/projects/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(project)
          });
          if (!response.ok) throw new Error('Failed to update project');
          return response.json();
        },
        async deleteProject(id) {
          const response = await fetch(`${API_BASE}/projects/${id}`, {
            method: 'DELETE'
          });
          if (!response.ok) throw new Error('Failed to delete project');
          return response.json();
        },
        // Customers
        async getCustomers() {
          const response = await fetch(`${API_BASE}/customers`);
          if (!response.ok) throw new Error('Failed to fetch customers');
          return response.json();
        },
        async createCustomer(customer) {
          const response = await fetch(`${API_BASE}/customers`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customer)
          });
          if (!response.ok) throw new Error('Failed to create customer');
          return response.json();
        },
        async updateCustomer(id, customer) {
          const response = await fetch(`${API_BASE}/customers/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customer)
          });
          if (!response.ok) throw new Error('Failed to update customer');
          return response.json();
        },
        async deleteCustomer(id) {
          const response = await fetch(`${API_BASE}/customers/${id}`, {
            method: 'DELETE'
          });
          if (!response.ok) throw new Error('Failed to delete customer');
          return response.json();
        },
        // Lists
        async getList(type) {
          const response = await fetch(`${API_BASE}/lists/${type}`);
          if (!response.ok) throw new Error(`Failed to fetch ${type} list`);
          return response.json();
        },
        async updateList(type, items) {
          const response = await fetch(`${API_BASE}/lists/${type}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items })
          });
          if (!response.ok) throw new Error(`Failed to update ${type} list`);
          return response.json();
        }
      };

      const CADWorkflowTracker = () => {
        const [projects, setProjects] = useState([]);
        const [filteredProjects, setFilteredProjects] = useState([]);
        const [searchTerm, setSearchTerm] = useState("");
        const [sortField, setSortField] = useState(null);
        const [sortDirection, setSortDirection] = useState('asc');
        const [statusFilter, setStatusFilter] = useState('');
        const [pmFilter, setPmFilter] = useState('');
        const [customerFilter, setCustomerFilter] = useState('');
        const [dateRangeStart, setDateRangeStart] = useState('');
        const [dateRangeEnd, setDateRangeEnd] = useState('');
        const [showDashboard, setShowDashboard] = useState(true);
        const [deletedProject, setDeletedProject] = useState(null);
        const [showForm, setShowForm] = useState(false);
        const [editingProject, setEditingProject] = useState(null);
        const [formData, setFormData] = useState({
          jobNumber: "",
          jobTitle: "",
          customer: "",
          projectManager: "",
          estimator: "",
          dateAssigned: "",
          status: "Assigned",
          description: "",
          documents: [],
          statusHistory: [],
        });
        const [showHistory, setShowHistory] = useState(null);
        const [showDetails, setShowDetails] = useState(null);
        const [showStatusChangeModal, setShowStatusChangeModal] =
          useState(false);
        const [pendingStatusChange, setPendingStatusChange] = useState(null);
        const [statusChangeDescription, setStatusChangeDescription] =
          useState("");
        const [toast, setToast] = useState(null);
        const [deleteConfirmation, setDeleteConfirmation] = useState(null);
        const [projectManagers, setProjectManagers] = useState([]);
        const [customers, setCustomers] = useState([]);
        const [estimators, setEstimators] = useState([]);
        const [customerDatabase, setCustomerDatabase] = useState([]);
        const [showCustomerManager, setShowCustomerManager] = useState(false);
        const [editingCustomer, setEditingCustomer] = useState(null);
        const [customerSearchQuery, setCustomerSearchQuery] = useState("");
        const [customerFormData, setCustomerFormData] = useState({
          companyName: "",
          contactPerson: "",
          email: "",
          phone: "",
          address: "",
          city: "",
          state: "",
          zip: "",
          notes: "",
        });
        const [showListManager, setShowListManager] = useState(null); // 'pm', 'customer', or 'estimator'
        const [listManagerValue, setListManagerValue] = useState("");
        const [editingListItem, setEditingListItem] = useState(null);
        const [showMergePDFModal, setShowMergePDFModal] = useState(false);
        const [pdfFilesToMerge, setPdfFilesToMerge] = useState([]);
        const [mergedFileName, setMergedFileName] = useState("combined.pdf");
        const [selectedProjects, setSelectedProjects] = useState([]);
        const [formErrors, setFormErrors] = useState({});
        const [showStatusBreakdown, setShowStatusBreakdown] = useState(false);
        const [showAverageTime, setShowAverageTime] = useState(false);
        const [showWorkload, setShowWorkload] = useState(false);

        // Toast notification function
        const showToast = (message, type = "success") => {
          setToast({ message, type });
          setTimeout(() => setToast(null), 3000);
        };

        const statusOptions = [
          "Assigned",
          "Submittal Drawings",
          "Customer Review",
          "Revisions Needed",
          "Accepted",
          "Production Drawings",
          "Scheduling",
          "Production",
          "Shipped",
        ];

        const statusColors = {
          Assigned: "bg-gray-200 text-gray-800",
          "Submittal Drawings": "bg-blue-200 text-blue-800",
          "Customer Review": "bg-yellow-200 text-yellow-800",
          "Revisions Needed": "bg-orange-200 text-orange-800",
          Accepted: "bg-green-200 text-green-800",
          "Production Drawings": "bg-purple-200 text-purple-800",
          Scheduling: "bg-indigo-200 text-indigo-800",
          Production: "bg-pink-200 text-pink-800",
          Shipped: "bg-teal-200 text-teal-800",
        };

        // Load data from MongoDB on mount
        useEffect(() => {
          const loadData = async () => {
            try {
              // Load projects
              const projectsData = await api.getProjects();
              setProjects(projectsData);
              setFilteredProjects(projectsData);

              // Load dropdown lists
              const pms = await api.getList('pm');
              setProjectManagers(pms);

              const customersList = await api.getList('customer');
              setCustomers(customersList);

              const estimatorsList = await api.getList('estimator');
              setEstimators(estimatorsList);

              // Load customer database
              const customersDB = await api.getCustomers();
              setCustomerDatabase(customersDB);
            } catch (error) {
              console.error('Error loading data:', error);
              showToast('Failed to load data from server', 'error');
            }
          };

          loadData();
        }, []);

        // Remove the old localStorage save effects - data is now saved via API calls

        // Search and filter functionality
        useEffect(() => {
          let filtered = [...projects];
          
          // Apply search filter
          if (searchTerm !== "") {
            filtered = filtered.filter(
              (project) =>
                project.jobNumber
                  .toLowerCase()
                  .includes(searchTerm.toLowerCase()) ||
                project.jobTitle
                  .toLowerCase()
                  .includes(searchTerm.toLowerCase()) ||
                project.customer
                  .toLowerCase()
                  .includes(searchTerm.toLowerCase())
            );
          }
          
          // Apply status filter
          if (statusFilter !== '') {
            filtered = filtered.filter(p => p.status === statusFilter);
          }
          
          // Apply PM filter
          if (pmFilter !== '') {
            filtered = filtered.filter(p => p.projectManager === pmFilter);
          }
          
          // Apply customer filter
          if (customerFilter !== '') {
            filtered = filtered.filter(p => p.customer === customerFilter);
          }
          
          // Apply date range filter
          if (dateRangeStart !== '') {
            filtered = filtered.filter(p => p.dateAssigned >= dateRangeStart);
          }
          if (dateRangeEnd !== '') {
            filtered = filtered.filter(p => p.dateAssigned <= dateRangeEnd);
          }
          
          // Apply sorting
          if (sortField) {
            filtered.sort((a, b) => {
              let aVal = a[sortField];
              let bVal = b[sortField];
              
              // Handle date sorting
              if (sortField === 'dateAssigned') {
                aVal = new Date(aVal);
                bVal = new Date(bVal);
              }
              
              if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
              if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
              return 0;
            });
          }
          
          setFilteredProjects(filtered);
          // Clear selection when search results change
          setSelectedProjects([]);
        }, [searchTerm, projects, sortField, sortDirection, statusFilter, pmFilter, customerFilter, dateRangeStart, dateRangeEnd]);

        const handleInputChange = (e) => {
          const { name, value } = e.target;

          // Clear error for this field when user starts typing
          if (formErrors[name]) {
            setFormErrors(prev => {
              const newErrors = {...prev};
              delete newErrors[name];
              return newErrors;
            });
          }

          // If status is changing, show modal for description
          if (name === "status" && value !== formData.status) {
            setPendingStatusChange(value);
            setShowStatusChangeModal(true);
          } else {
            setFormData((prev) => ({ ...prev, [name]: value }));
          }
        };
        
        const validateForm = () => {
          const errors = {};
          
          if (!formData.jobNumber.trim()) errors.jobNumber = 'Job number is required';
          if (!formData.jobTitle.trim()) errors.jobTitle = 'Job title is required';
          if (!formData.customer.trim()) errors.customer = 'Customer is required';
          if (!formData.projectManager.trim()) errors.projectManager = 'Project manager is required';
          if (!formData.dateAssigned) errors.dateAssigned = 'Date assigned is required';
          if (!formData.status) errors.status = 'Status is required';
          
          setFormErrors(errors);
          return Object.keys(errors).length === 0;
        };

        const confirmStatusChange = () => {
          if (pendingStatusChange) {
            const newHistoryEntry = {
              status: pendingStatusChange,
              timestamp: new Date().toISOString(),
              date: new Date().toLocaleString(),
              description: statusChangeDescription,
            };

            setFormData((prev) => ({
              ...prev,
              status: pendingStatusChange,
              statusHistory: [...prev.statusHistory, newHistoryEntry],
            }));

            showToast(`Status updated to ${pendingStatusChange}`, "success");

            // Reset modal state
            setShowStatusChangeModal(false);
            setPendingStatusChange(null);
            setStatusChangeDescription("");
          }
        };

        const cancelStatusChange = () => {
          setShowStatusChangeModal(false);
          setPendingStatusChange(null);
          setStatusChangeDescription("");
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          
          if (!validateForm()) {
            showToast('Please fill in all required fields', 'error');
            return;
          }

          try {
            if (editingProject) {
              // Update existing project in MongoDB
              const updatedProject = await api.updateProject(editingProject._id, {
                ...formData,
                id: editingProject.id
              });
              setProjects((prev) =>
                prev.map((p) =>
                  p._id === editingProject._id ? updatedProject : p
                )
              );
              showToast("Project updated successfully!", "success");
            } else {
              // Add new project with initial status history
              const initialHistory = [
                {
                  status: formData.status,
                  timestamp: new Date().toISOString(),
                  date: new Date().toLocaleString(),
                  description: "",
                },
              ];

              const newProjectData = {
                ...formData,
                id: Date.now().toString(),
                createdDate: new Date().toISOString(),
                statusHistory:
                  formData.statusHistory.length > 0
                    ? formData.statusHistory
                    : initialHistory,
              };
              
              const newProject = await api.createProject(newProjectData);
              setProjects((prev) => [...prev, newProject]);
              showToast("Project created successfully!", "success");
            }

            resetForm();
          } catch (error) {
            console.error("Error saving project:", error);
            showToast("Error saving project to database", "error");
          }
        };

        const resetForm = () => {
          setFormData({
            jobNumber: "",
            jobTitle: "",
            customer: "",
            projectManager: "",
            estimator: "",
            dateAssigned: "",
            status: "Assigned",
            description: "",
            documents: [],
            statusHistory: [],
          });
          setFormErrors({});
          setEditingProject(null);
          setShowForm(false);
        };

        const handleEdit = (project) => {
          // Ensure statusHistory exists for older projects and add description field if missing
          const statusHistory = project.statusHistory || [
            {
              status: project.status,
              timestamp: project.createdDate || new Date().toISOString(),
              date: new Date(
                project.createdDate || new Date()
              ).toLocaleString(),
              description: "",
            },
          ];

          // Ensure all history entries have description field
          const updatedHistory = statusHistory.map((entry) => ({
            ...entry,
            description: entry.description || "",
          }));

          const projectData = {
            ...project,
            statusHistory: updatedHistory,
          };
          setFormData(projectData);
          setEditingProject(project);
          setShowForm(true);
        };

        const handleDelete = (project) => {
          setDeleteConfirmation(project);
        };

        const confirmDelete = async () => {
          if (deleteConfirmation) {
            try {
              await api.deleteProject(deleteConfirmation._id);
              setDeletedProject(deleteConfirmation); // Store for undo
              setProjects((prev) =>
                prev.filter((p) => p._id !== deleteConfirmation._id)
              );
              showToast("Project deleted. Click to undo.", "success");
              setDeleteConfirmation(null);
              
              // Clear the undo after 10 seconds
              setTimeout(() => {
                setDeletedProject(null);
              }, 10000);
            } catch (error) {
              console.error("Error deleting project:", error);
              showToast("Error deleting project", "error");
            }
          }
        };
        
        const undoDelete = async () => {
          if (deletedProject) {
            try {
              const restoredProject = await api.createProject(deletedProject);
              setProjects((prev) => [...prev, restoredProject]);
              showToast("Project restored", "success");
              setDeletedProject(null);
            } catch (error) {
              console.error("Error restoring project:", error);
              showToast("Error restoring project", "error");
            }
          }
        };

        const cancelDelete = () => {
          setDeleteConfirmation(null);
        };

        // List management functions
        const openListManager = (type) => {
          setShowListManager(type);
          setListManagerValue("");
          setEditingListItem(null);
        };

        const closeListManager = () => {
          setShowListManager(null);
          setListManagerValue("");
          setEditingListItem(null);
        };

        const addToList = async () => {
          if (!listManagerValue.trim()) return;

          try {
            if (showListManager === "pm") {
              if (!projectManagers.includes(listManagerValue.trim())) {
                const updatedList = [...projectManagers, listManagerValue.trim()];
                setProjectManagers(updatedList);
                await api.updateList('pm', updatedList);
                showToast("Project Manager added", "success");
              }
            } else if (showListManager === "customer") {
              if (!customers.includes(listManagerValue.trim())) {
                const updatedList = [...customers, listManagerValue.trim()];
                setCustomers(updatedList);
                await api.updateList('customer', updatedList);
                showToast("Customer added", "success");
              }
            } else if (showListManager === "estimator") {
              if (!estimators.includes(listManagerValue.trim())) {
                const updatedList = [...estimators, listManagerValue.trim()];
                setEstimators(updatedList);
                await api.updateList('estimator', updatedList);
                showToast("Estimator added", "success");
              }
            }
            setListManagerValue("");
          } catch (error) {
            console.error("Error adding to list:", error);
            showToast("Error adding to list", "error");
          }
        };

        const editListItem = (item) => {
          setEditingListItem(item);
          setListManagerValue(item);
        };

        const saveEditedItem = async () => {
          if (!listManagerValue.trim() || !editingListItem) return;

          try {
            if (showListManager === "pm") {
              const updatedList = projectManagers.map((pm) =>
                pm === editingListItem ? listManagerValue.trim() : pm
              );
              setProjectManagers(updatedList);
              await api.updateList('pm', updatedList);
              showToast("Project Manager updated", "success");
            } else if (showListManager === "customer") {
              const updatedList = customers.map((c) =>
                c === editingListItem ? listManagerValue.trim() : c
              );
              setCustomers(updatedList);
              await api.updateList('customer', updatedList);
              showToast("Customer updated", "success");
            } else if (showListManager === "estimator") {
              const updatedList = estimators.map((e) =>
                e === editingListItem ? listManagerValue.trim() : e
              );
              setEstimators(updatedList);
              await api.updateList('estimator', updatedList);
              showToast("Estimator updated", "success");
            }

            setListManagerValue("");
            setEditingListItem(null);
          } catch (error) {
            console.error("Error updating list item:", error);
            showToast("Error updating list item", "error");
          }
        };

        const deleteFromList = async (item) => {
          try {
            if (showListManager === "pm") {
              const updatedList = projectManagers.filter((pm) => pm !== item);
              setProjectManagers(updatedList);
              await api.updateList('pm', updatedList);
              showToast("Project Manager deleted", "success");
            } else if (showListManager === "customer") {
              const updatedList = customers.filter((c) => c !== item);
              setCustomers(updatedList);
              await api.updateList('customer', updatedList);
              showToast("Customer deleted", "success");
            } else if (showListManager === "estimator") {
              const updatedList = estimators.filter((e) => e !== item);
              setEstimators(updatedList);
              await api.updateList('estimator', updatedList);
              showToast("Estimator deleted", "success");
            }
          } catch (error) {
            console.error("Error deleting from list:", error);
            showToast("Error deleting from list", "error");
          }
        };

        const selectFromList = (item) => {
          if (showListManager === "pm") {
            setFormData((prev) => ({ ...prev, projectManager: item }));
          } else if (showListManager === "customer") {
            setFormData((prev) => ({ ...prev, customer: item }));
          } else if (showListManager === "estimator") {
            setFormData((prev) => ({ ...prev, estimator: item }));
          }
          closeListManager();
        };

        // PDF Merge Functions
        const openMergePDFModal = () => {
          setShowMergePDFModal(true);
          setPdfFilesToMerge([]);
          setMergedFileName("combined.pdf");
        };

        const closeMergePDFModal = () => {
          setShowMergePDFModal(false);
          setPdfFilesToMerge([]);
          setMergedFileName("combined.pdf");
        };

        const handlePDFFilesSelect = (e) => {
          const files = Array.from(e.target.files).filter(
            (f) => f.type === "application/pdf"
          );
          if (files.length !== e.target.files.length) {
            showToast("Only PDF files can be merged", "error");
          }
          setPdfFilesToMerge(files);
        };

        const removePDFFromMerge = (index) => {
          setPdfFilesToMerge((prev) => prev.filter((_, i) => i !== index));
        };

        const movePDFUp = (index) => {
          if (index === 0) return;
          const newFiles = [...pdfFilesToMerge];
          [newFiles[index - 1], newFiles[index]] = [
            newFiles[index],
            newFiles[index - 1],
          ];
          setPdfFilesToMerge(newFiles);
        };

        const movePDFDown = (index) => {
          if (index === pdfFilesToMerge.length - 1) return;
          const newFiles = [...pdfFilesToMerge];
          [newFiles[index], newFiles[index + 1]] = [
            newFiles[index + 1],
            newFiles[index],
          ];
          setPdfFilesToMerge(newFiles);
        };

        const mergePDFs = async () => {
          if (pdfFilesToMerge.length < 2) {
            showToast("Please select at least 2 PDF files to merge", "error");
            return;
          }

          try {
            showToast("Merging PDFs...", "info");

            const { PDFDocument } = window.PDFLib;
            const mergedPdf = await PDFDocument.create();

            for (const file of pdfFilesToMerge) {
              const arrayBuffer = await file.arrayBuffer();
              const pdf = await PDFDocument.load(arrayBuffer);
              const copiedPages = await mergedPdf.copyPages(
                pdf,
                pdf.getPageIndices()
              );
              copiedPages.forEach((page) => mergedPdf.addPage(page));
            }

            const mergedPdfBytes = await mergedPdf.save();
            const blob = new Blob([mergedPdfBytes], {
              type: "application/pdf",
            });

            // Convert to base64 for storage
            const reader = new FileReader();
            reader.onload = (e) => {
              const mergedDoc = {
                name: mergedFileName,
                type: "application/pdf",
                size: blob.size,
                data: e.target.result,
              };

              // Check size
              if (blob.size > 20 * 1024 * 1024) {
                showToast(
                  "Merged PDF is too large (max 20MB). Try compressing or merging fewer files.",
                  "error"
                );
                return;
              }

              // Warn for large files
              if (blob.size > 10 * 1024 * 1024) {
                const sizeMB = (blob.size / 1024 / 1024).toFixed(2);
                showToast(
                  `Warning: Merged PDF is ${sizeMB}MB and may cause storage issues`,
                  "error"
                );
              }

              setFormData((prev) => ({
                ...prev,
                documents: [...prev.documents, mergedDoc],
              }));

              showToast("PDFs merged successfully!", "success");
              closeMergePDFModal();
            };
            reader.readAsDataURL(blob);
          } catch (error) {
            console.error("Error merging PDFs:", error);
            showToast("Error merging PDFs", "error");
          }
        };

        // Customer Database Management Functions
        const openCustomerManager = () => {
          setShowCustomerManager(true);
          setEditingCustomer(null);
          setCustomerFormData({
            companyName: "",
            contactPerson: "",
            email: "",
            phone: "",
            address: "",
            city: "",
            state: "",
            zip: "",
            notes: "",
          });
        };

        const closeCustomerManager = () => {
          setShowCustomerManager(false);
          setEditingCustomer(null);
          setCustomerSearchQuery("");
          setCustomerFormData({
            companyName: "",
            contactPerson: "",
            email: "",
            phone: "",
            address: "",
            city: "",
            state: "",
            zip: "",
            notes: "",
          });
        };

        const handleCustomerFormChange = (e) => {
          const { name, value } = e.target;
          setCustomerFormData((prev) => ({ ...prev, [name]: value }));
        };

        const saveCustomer = async () => {
          if (!customerFormData.companyName.trim()) {
            showToast("Company name is required", "error");
            return;
          }

          try {
            if (editingCustomer) {
              // Update existing customer in MongoDB
              const updatedCustomer = await api.updateCustomer(editingCustomer._id, customerFormData);
              setCustomerDatabase((prev) =>
                prev.map((c) =>
                  c._id === editingCustomer._id ? updatedCustomer : c
                )
              );
              showToast("Customer updated successfully", "success");
            } else {
              // Add new customer to MongoDB
              const newCustomer = await api.createCustomer(customerFormData);
              setCustomerDatabase((prev) => [...prev, newCustomer]);

              // Also add to simple customer list if not already there
              if (!customers.includes(customerFormData.companyName)) {
                const updatedCustomers = [...customers, customerFormData.companyName];
                setCustomers(updatedCustomers);
                await api.updateList('customer', updatedCustomers);
              }

              showToast("Customer added successfully", "success");
            }

            closeCustomerManager();
          } catch (error) {
            console.error("Error saving customer:", error);
            showToast("Error saving customer to database", "error");
          }
        };

        const editCustomerRecord = (customer) => {
          setEditingCustomer(customer);
          setCustomerFormData(customer);
          setShowCustomerManager(true);
        };

        const deleteCustomerRecord = async (customerId) => {
          try {
            await api.deleteCustomer(customerId);
            setCustomerDatabase((prev) =>
              prev.filter((c) => c._id !== customerId)
            );
            showToast("Customer deleted", "success");
          } catch (error) {
            console.error("Error deleting customer:", error);
            showToast("Error deleting customer", "error");
          }
        };

        const selectCustomerFromDB = (customer) => {
          setFormData((prev) => ({ ...prev, customer: customer.companyName }));
        };

        // Project Selection Functions
        const toggleProjectSelection = (projectId) => {
          setSelectedProjects((prev) => {
            if (prev.includes(projectId)) {
              return prev.filter((id) => id !== projectId);
            } else {
              return [...prev, projectId];
            }
          });
        };

        const toggleSelectAll = () => {
          if (selectedProjects.length === filteredProjects.length) {
            setSelectedProjects([]);
          } else {
            setSelectedProjects(filteredProjects.map((p) => p._id));
          }
        };

        const clearSelection = () => {
          setSelectedProjects([]);
        };
        
        const handleSort = (field) => {
          if (sortField === field) {
            // Toggle direction if same field
            setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
          } else {
            // New field, default to ascending
            setSortField(field);
            setSortDirection('asc');
          }
        };
        
        const clearFilters = () => {
          setSearchTerm('');
          setStatusFilter('');
          setPmFilter('');
          setCustomerFilter('');
          setDateRangeStart('');
          setDateRangeEnd('');
          setSortField(null);
          setSortDirection('asc');
        };
        
        const exportData = () => {
          const dataStr = JSON.stringify({
            projects,
            projectManagers,
            customers,
            estimators,
            customerDatabase,
            exportDate: new Date().toISOString()
          }, null, 2);
          
          const dataBlob = new Blob([dataStr], { type: 'application/json' });
          const url = URL.createObjectURL(dataBlob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `cad-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
          showToast('Data exported successfully', 'success');
        };
        
        const importData = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const data = JSON.parse(e.target.result);
              
              if (data.projects) setProjects(data.projects);
              if (data.projectManagers) setProjectManagers(data.projectManagers);
              if (data.customers) setCustomers(data.customers);
              if (data.estimators) setEstimators(data.estimators);
              if (data.customerDatabase) setCustomerDatabase(data.customerDatabase);
              
              showToast('Data imported successfully', 'success');
            } catch (error) {
              console.error('Import error:', error);
              showToast('Error importing data. Please check the file format.', 'error');
            }
          };
          reader.readAsText(file);
          event.target.value = ''; // Reset input
        };
        
        // Keyboard shortcuts
        useEffect(() => {
          const handleKeyDown = (e) => {
            // Esc to close modals
            if (e.key === 'Escape') {
              setShowForm(false);
              setShowHistory(null);
              setShowDetails(null);
              setShowStatusChangeModal(false);
              setShowCustomerManager(false);
              setShowListManager(null);
              setShowMergePDFModal(false);
              setDeleteConfirmation(null);
              setShowDashboard(false);
            }
            
            // Ctrl+S to save form (prevent default browser save)
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
              e.preventDefault();
              if (showForm) {
                document.querySelector('form')?.requestSubmit();
              }
            }
            
            // Ctrl+N for new project
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
              e.preventDefault();
              setShowForm(true);
            }
          };
          
          window.addEventListener('keydown', handleKeyDown);
          return () => window.removeEventListener('keydown', handleKeyDown);
        }, [showForm, showHistory, showDetails, showStatusChangeModal, showCustomerManager, showListManager, showMergePDFModal, deleteConfirmation, showDashboard]);

        const handleDocumentUpload = (e) => {
          const files = Array.from(e.target.files);

          if (files.length === 0) return;

          console.log(
            "Uploading files:",
            files.map((f) => ({ name: f.name, size: f.size, type: f.type }))
          );

          // Show file info upfront
          files.forEach((file) => {
            const sizeMB = (file.size / 1024 / 1024).toFixed(2);
            console.log(
              `File: "${file.name}" - ${sizeMB}MB - Type: ${file.type}`
            );
          });

          processFiles(files);
        };
        
        const processFiles = (files) => {
          // Process each file and convert to base64
          const filePromises = files.map((file) => {
            return new Promise((resolve, reject) => {
              const sizeMB = (file.size / 1024 / 1024).toFixed(2);

              // File size limit: 20MB per file
              if (file.size > 20 * 1024 * 1024) {
                console.error(`File too large: ${file.name} (${sizeMB}MB)`);
                showToast(
                  `"${file.name}" (${sizeMB}MB) exceeds 20MB limit. Please compress or split the file.`,
                  "error"
                );
                resolve(null);
                return;
              }

              // Strong warning for files over 10MB
              if (file.size > 10 * 1024 * 1024) {
                console.warn(
                  `Very large file: ${file.name} (${sizeMB}MB) - may cause storage issues`
                );
                showToast(
                  `Warning: "${file.name}" (${sizeMB}MB) is very large and may cause issues`,
                  "error"
                );
              }

              // Mild warning for files over 5MB
              if (
                file.size > 5 * 1024 * 1024 &&
                file.size <= 10 * 1024 * 1024
              ) {
                console.warn(`Large file: ${file.name} (${sizeMB}MB)`);
                showToast(`Large file detected: ${sizeMB}MB`, "info");
              }

              const reader = new FileReader();
              reader.onload = (e) => {
                console.log(`Successfully loaded: ${file.name} (${sizeMB}MB)`);
                resolve({
                  name: file.name,
                  type: file.type,
                  size: file.size,
                  data: e.target.result, // base64 data
                });
              };
              reader.onerror = (error) => {
                console.error(`Error reading file ${file.name}:`, error);
                showToast(
                  `Failed to read "${file.name}" (${sizeMB}MB)`,
                  "error"
                );
                resolve(null);
              };
              reader.readAsDataURL(file);
            });
          });

          Promise.all(filePromises)
            .then((results) => {
              console.log("Upload results:", results);

              // Filter out null results (failed uploads)
              const successfulUploads = results.filter((r) => r !== null);

              console.log(
                `Successful: ${successfulUploads.length}, Failed: ${
                  results.length - successfulUploads.length
                }`
              );

              if (successfulUploads.length > 0) {
                setFormData((prev) => ({
                  ...prev,
                  documents: [...prev.documents, ...successfulUploads],
                }));
                showToast(
                  `${successfulUploads.length} document(s) uploaded successfully`,
                  "success"
                );
              }

              // Don't show generic error if specific errors were already shown
              if (successfulUploads.length === 0 && files.length > 0) {
                const totalSizeMB = (
                  files.reduce((sum, f) => sum + f.size, 0) /
                  1024 /
                  1024
                ).toFixed(2);
                console.error(`All files failed. Total size: ${totalSizeMB}MB`);
              }
            })
            .catch((error) => {
              console.error("Upload error:", error);
              showToast("Unexpected error uploading documents", "error");
            });
        };
        
        const handleDragOver = (e) => {
          e.preventDefault();
          e.stopPropagation();
        };
        
        const handleDrop = (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          const files = Array.from(e.dataTransfer.files);
          if (files.length > 0) {
            processFiles(files);
          }
        };

        const removeDocument = (index) => {
          setFormData((prev) => ({
            ...prev,
            documents: prev.documents.filter((_, i) => i !== index),
          }));
        };

        const exportToPDF = () => {
          // Determine which projects to export
          const projectsToExport =
            selectedProjects.length > 0
              ? filteredProjects.filter((p) => selectedProjects.includes(p._id))
              : filteredProjects;

          if (projectsToExport.length === 0) {
            showToast("No projects to export", "error");
            return;
          }

          showToast(
            `Generating PDF report for ${projectsToExport.length} project(s)...`,
            "info"
          );

          // Create a printable version
          const printWindow = window.open("", "_blank");
          const projectsHTML = projectsToExport
            .map(
              (p) => `
              <div style="margin-bottom: 20px; page-break-inside: avoid; border: 1px solid #ddd; padding: 12px;">
                <h3 style="margin: 0 0 10px 0; color: #333;">${p.jobNumber} - ${
                p.jobTitle
              }</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <tr><td style="padding: 3px; font-weight: bold;">Customer:</td><td style="padding: 3px;">${
                    p.customer
                  }</td></tr>
                  <tr><td style="padding: 3px; font-weight: bold;">Project Manager:</td><td style="padding: 3px;">${
                    p.projectManager
                  }</td></tr>
                  <tr><td style="padding: 3px; font-weight: bold;">Estimator:</td><td style="padding: 3px;">${
                    p.estimator
                  }</td></tr>
                  <tr><td style="padding: 3px; font-weight: bold;">Date Assigned:</td><td style="padding: 3px;">${
                    p.dateAssigned
                  }</td></tr>
                  <tr><td style="padding: 3px; font-weight: bold;">Current Status:</td><td style="padding: 3px;">${
                    p.status
                  }</td></tr>
                  <tr><td style="padding: 3px; font-weight: bold;">Description:</td><td style="padding: 3px;">${
                    p.description
                  }</td></tr>
                  ${
                    p.documents.length > 0
                      ? `<tr><td style="padding: 3px; font-weight: bold;">Documents:</td><td style="padding: 3px;">${p.documents
                          .map((d) => (typeof d === "string" ? d : d.name))
                          .join(", ")}</td></tr>`
                      : ""
                  }
                </table>
                ${
                  p.statusHistory && p.statusHistory.length > 0
                    ? `
                  <div style="margin-top: 10px;">
                    <strong>Status History:</strong>
                    <ul style="list-style: none; padding-left: 0; margin-top: 8px;">
                      ${p.statusHistory
                        .map(
                          (entry, idx) => `
                        <li style="padding: 6px; margin-bottom: 4px; background: #f9f9f9; border-left: 3px solid #3b82f6;">
                          <strong>${entry.status}</strong> - ${entry.date}
                          ${
                            entry.description
                              ? `<br><em style="color: #555; font-size: 0.9em;">${entry.description}</em>`
                              : ""
                          }
                          ${
                            idx < p.statusHistory.length - 1
                              ? `<br><small style="color: #666;">Duration: ${Math.floor(
                                  (new Date(
                                    p.statusHistory[idx + 1].timestamp
                                  ) -
                                    new Date(entry.timestamp)) /
                                    (1000 * 60 * 60 * 24)
                                )} days</small>`
                              : ""
                          }
                          ${
                            idx === p.statusHistory.length - 1
                              ? `<br><small style="color: #666;">Duration: ${Math.floor(
                                  (new Date() - new Date(entry.timestamp)) /
                                    (1000 * 60 * 60 * 24)
                                )} days (ongoing)</small>`
                              : ""
                          }
                        </li>
                      `
                        )
                        .join("")}
                    </ul>
                    <small style="color: #666;">Total time: ${Math.floor(
                      (new Date() - new Date(p.statusHistory[0].timestamp)) /
                        (1000 * 60 * 60 * 24)
                    )} days</small>
                  </div>
                `
                    : ""
                }
              </div>
            `
            )
            .join("");

          printWindow.document.write(`
              <html>
                <head>
                  <title>Lindsay Precast Drafter Projects Report</title>
                  <style>
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body { font-family: Arial, sans-serif; padding: 20px; position: relative; min-height: 100vh; }
                    h1 { color: #333; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 10px; }
                    p { margin: 5px 0; }
                    hr { margin: 15px 0; }
                    .footer { 
                      margin-top: 40px; 
                      padding-top: 20px; 
                      border-top: 1px solid #ddd; 
                      text-align: center; 
                      color: #666; 
                      font-size: 0.9em;
                    }
                    @media print {
                      button { display: none; }
                      body { padding: 10px; }
                      @page { 
                        margin: 0.5in;
                        @bottom-center {
                          content: "Lindsay Precast Drafter Workflow Tracker - " counter(page) " of " counter(pages);
                        }
                      }
                      .footer { 
                        position: fixed; 
                        bottom: 0; 
                        left: 0; 
                        right: 0; 
                        padding: 10px 0; 
                      }
                    }
                  </style>
                </head>
                <body>
                  <h1>Lindsay Precast Drafter Projects Report</h1>
                  <p>Generated: ${new Date().toLocaleString()}</p>
                  <p>${
                    selectedProjects.length > 0
                      ? `Selected Projects: ${projectsToExport.length}`
                      : `Total Projects: ${projectsToExport.length}`
                  }</p>
                  <hr>
                  ${projectsHTML}
                  <div class="footer">
                    <p>Lindsay Precast Drafter Workflow Tracker | Â© ${new Date().getFullYear()} Lindsay Precast | Track projects from assignment to shipment</p>
                  </div>
                  <button onclick="window.print()" style="margin-top: 20px; padding: 10px 20px; background: #3b82f6; color: white; border: none; cursor: pointer; border-radius: 5px;">Print/Save as PDF</button>
                </body>
              </html>
            `);
          printWindow.document.close();

          // Clear selection after export
          if (selectedProjects.length > 0) {
            showToast(
              `${projectsToExport.length} selected project(s) exported`,
              "success"
            );
            setSelectedProjects([]);
          }
        };

        // Lucide-react icons as inline SVG
        const SearchIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
        );

        const PlusIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        );

        const FileTextIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
        );

        const Edit2Icon = () => (
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
          </svg>
        );

        const Trash2Icon = () => (
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <polyline points="3 6 5 6 21 6"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            <line x1="10" y1="11" x2="10" y2="17"></line>
            <line x1="14" y1="11" x2="14" y2="17"></line>
          </svg>
        );

        const UploadIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        );

        const XIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        );

        const SaveIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
            <polyline points="17 21 17 13 7 13 7 21"></polyline>
            <polyline points="7 3 7 8 15 8"></polyline>
          </svg>
        );

        const ClockIcon = () => (
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        );

        const EyeIcon = () => (
          <svg
            width="18"
            height="18"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
            <circle cx="12" cy="12" r="3"></circle>
          </svg>
        );

        const DownloadIcon = () => (
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="7 10 12 15 17 10"></polyline>
            <line x1="12" y1="15" x2="12" y2="3"></line>
          </svg>
        );

        const CheckCircleIcon = () => (
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
        );

        const AlertCircleIcon = () => (
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
        );

        const InfoIcon = () => (
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
        );

        const ArrowUpIcon = () => (
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="12" y1="19" x2="12" y2="5"></line>
            <polyline points="5 12 12 5 19 12"></polyline>
          </svg>
        );

        const ArrowDownIcon = () => (
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <polyline points="19 12 12 19 5 12"></polyline>
          </svg>
        );

        const MergeIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <polyline points="18 15 12 9 6 15"></polyline>
          </svg>
        );

        const UsersIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
            <circle cx="9" cy="7" r="4"></circle>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
          </svg>
        );
        
        const BarChartIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <line x1="12" y1="20" x2="12" y2="10"></line>
            <line x1="18" y1="20" x2="18" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="16"></line>
          </svg>
        );
        
        const FilterIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
        );
        
        const DownloadCloudIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <polyline points="8 17 12 21 16 17"></polyline>
            <line x1="12" y1="12" x2="12" y2="21"></line>
            <path d="M20.88 18.09A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.29"></path>
          </svg>
        );
        
        const UploadCloudIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <polyline points="16 16 12 12 8 16"></polyline>
            <line x1="12" y1="12" x2="12" y2="21"></line>
            <path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"></path>
            <polyline points="16 16 12 12 8 16"></polyline>
          </svg>
        );
        
        const ArrowUpDownIcon = () => (
          <svg
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="m21 16-4 4-4-4"></path>
            <path d="M17 20V4"></path>
            <path d="m3 8 4-4 4 4"></path>
            <path d="M7 4v16"></path>
          </svg>
        );
        
        const UndoIcon = () => (
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            strokeWidth="2"
            strokeLinecap="round"
            strokeLinejoin="round"
          >
            <path d="M3 7v6h6"></path>
            <path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"></path>
          </svg>
        );

        const handleDownloadDocument = (doc) => {
          if (typeof doc === "object" && doc.data) {
            // Create a temporary link and trigger download
            const link = document.createElement("a");
            link.href = doc.data;
            link.download = doc.name;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          }
        };

        return (
          <div className="min-h-screen bg-gray-50 p-6">
            <div className="max-w-7xl mx-auto">
              {/* Header */}
              <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900">
                      Lindsay Precast Drafter Workflow Tracker
                    </h1>
                    <p className="text-gray-600 mt-1">
                      Track projects from assignment to shipment
                    </p>
                  </div>
                  <div className="flex gap-3">
                    {!showDashboard && (
                    <button
                      onClick={() => setShowDashboard(true)}
                      className="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition"
                    >
                      <BarChartIcon />
                      Dashboard
                    </button>
                    )}
                    {showDashboard && (
                    <button
                      onClick={() => setShowDashboard(false)}
                      className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                    >
                      <FileTextIcon />
                      View Jobs
                    </button>
                    )}
                    <button
                      onClick={openCustomerManager}
                      className="flex items-center gap-2 bg-teal-600 text-white px-4 py-2 rounded-lg hover:bg-teal-700 transition"
                    >
                      <UsersIcon />
                      Manage Customers
                    </button>
                    <button
                      onClick={() => setShowForm(!showForm)}
                      className="flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                    >
                      <PlusIcon />
                      New Project
                    </button>
                  </div>
                </div>

                {/* Filters Row - Hidden in Dashboard View */}
                {!showDashboard && (
                <div className="grid grid-cols-6 gap-3 mb-4">
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Status</label>
                    <select
                      value={statusFilter}
                      onChange={(e) => setStatusFilter(e.target.value)}
                      className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="">All Statuses</option>
                      {statusOptions.map(status => (
                        <option key={status} value={status}>{status}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Project Manager</label>
                    <select
                      value={pmFilter}
                      onChange={(e) => setPmFilter(e.target.value)}
                      className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="">All PMs</option>
                      {projectManagers.map(pm => (
                        <option key={pm} value={pm}>{pm}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Customer</label>
                    <select
                      value={customerFilter}
                      onChange={(e) => setCustomerFilter(e.target.value)}
                      className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    >
                      <option value="">All Customers</option>
                      {customers.map(customer => (
                        <option key={customer} value={customer}>{customer}</option>
                      ))}
                    </select>
                  </div>
                  
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Date From</label>
                    <input
                      type="date"
                      value={dateRangeStart}
                      onChange={(e) => setDateRangeStart(e.target.value)}
                      className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-xs font-medium text-gray-700 mb-1">Date To</label>
                    <input
                      type="date"
                      value={dateRangeEnd}
                      onChange={(e) => setDateRangeEnd(e.target.value)}
                      className="w-full px-2 py-1.5 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  
                  <div className="flex items-end">
                    <button
                      onClick={clearFilters}
                      className="w-full flex items-center justify-center gap-2 px-3 py-1.5 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                    >
                      <FilterIcon />
                      Clear Filters
                    </button>
                  </div>
                </div>
                )}

                {/* Search and Export - Hidden in Dashboard View */}
                {!showDashboard && (
                <div className="flex gap-4">
                  <div className="flex-1 relative">
                    <div className="absolute left-3 top-3 text-gray-400">
                      <SearchIcon />
                    </div>
                    <input
                      type="text"
                      placeholder="Search by job number, title, or customer..."
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                  </div>
                  {selectedProjects.length > 0 && (
                    <button
                      onClick={clearSelection}
                      className="flex items-center gap-2 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition"
                    >
                      Clear ({selectedProjects.length})
                    </button>
                  )}
                  <button
                    onClick={exportToPDF}
                    className="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition"
                  >
                    <FileTextIcon />
                    {selectedProjects.length > 0
                      ? `Export Selected (${selectedProjects.length})`
                      : "Export PDF"}
                  </button>
                </div>
                )}
              </div>

              {/* Dashboard */}
              {showDashboard && (
                <div className="bg-white rounded-lg shadow-sm p-6 mb-6">
                  <div className="mb-6">
                    <h2 className="text-2xl font-bold text-gray-900">Dashboard & Analytics</h2>
                  </div>
                  
                  {/* Key Metrics */}
                  <div className="grid grid-cols-4 gap-4 mb-6">
                    <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                      <div className="text-sm font-medium text-blue-600 mb-1">Total Projects</div>
                      <div className="text-3xl font-bold text-blue-900">{projects.length}</div>
                    </div>
                    <div className="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
                      <div className="text-sm font-medium text-yellow-600 mb-1">In Progress</div>
                      <div className="text-3xl font-bold text-yellow-900">
                        {projects.filter(p => !['Shipped', 'Assigned'].includes(p.status)).length}
                      </div>
                    </div>
                    <div className="bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg p-4 border border-orange-200">
                      <div className="text-sm font-medium text-orange-600 mb-1">Needs Revision</div>
                      <div className="text-3xl font-bold text-orange-900">
                        {projects.filter(p => p.status === 'Revisions Needed').length}
                      </div>
                    </div>
                    <div className="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                      <div className="text-sm font-medium text-green-600 mb-1">Shipped</div>
                      <div className="text-3xl font-bold text-green-900">
                        {projects.filter(p => p.status === 'Shipped').length}
                      </div>
                    </div>
                  </div>
                  
                  {/* Status Breakdown - Collapsible */}
                  <div className="mb-6 border border-gray-200 rounded-lg">
                    <button
                      onClick={() => setShowStatusBreakdown(!showStatusBreakdown)}
                      className="w-full flex justify-between items-center p-4 hover:bg-gray-50 transition"
                    >
                      <h3 className="text-lg font-semibold text-gray-900">Projects by Status</h3>
                      <span className="text-gray-500 text-xl">
                        {showStatusBreakdown ? 'â' : '+'}
                      </span>
                    </button>
                    {showStatusBreakdown && (
                    <div className="p-4 pt-0">
                      <div className="grid grid-cols-3 gap-4">
                        {statusOptions.map(status => {
                          const count = projects.filter(p => p.status === status).length;
                          const percentage = projects.length > 0 ? ((count / projects.length) * 100).toFixed(1) : 0;
                          return (
                            <div key={status} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                              <div className="flex justify-between items-start mb-2">
                                <span className={`text-xs px-2 py-1 rounded-full font-medium ${statusColors[status]}`}>
                                  {status}
                                </span>
                                <span className="text-2xl font-bold text-gray-900">{count}</span>
                              </div>
                              <div className="w-full bg-gray-200 rounded-full h-2 mt-2">
                                <div 
                                  className="bg-blue-600 h-2 rounded-full transition-all" 
                                  style={{width: `${percentage}%`}}
                                ></div>
                              </div>
                              <div className="text-xs text-gray-600 mt-1">{percentage}% of total</div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    )}
                  </div>
                  
                  {/* Average Time per Status - Collapsible */}
                  <div className="mb-6 border border-gray-200 rounded-lg">
                    <button
                      onClick={() => setShowAverageTime(!showAverageTime)}
                      className="w-full flex justify-between items-center p-4 hover:bg-gray-50 transition"
                    >
                      <h3 className="text-lg font-semibold text-gray-900">Average Time in Each Status</h3>
                      <span className="text-gray-500 text-xl">
                        {showAverageTime ? 'â' : '+'}
                      </span>
                    </button>
                    {showAverageTime && (
                    <div className="p-4 pt-0">
                      <div className="grid grid-cols-3 gap-4">
                        {statusOptions.map(status => {
                          const projectsWithStatus = projects.filter(p => 
                            p.statusHistory && p.statusHistory.some(h => h.status === status)
                          );
                          
                          let avgDays = 0;
                          if (projectsWithStatus.length > 0) {
                            const totalDays = projectsWithStatus.reduce((sum, project) => {
                              const statusEntries = project.statusHistory.filter(h => h.status === status);
                              if (statusEntries.length > 0) {
                                const statusIndex = project.statusHistory.findIndex(h => h.status === status);
                                const nextIndex = statusIndex + 1;
                                const startTime = new Date(statusEntries[0].timestamp);
                                const endTime = nextIndex < project.statusHistory.length 
                                  ? new Date(project.statusHistory[nextIndex].timestamp)
                                  : new Date();
                                const days = Math.floor((endTime - startTime) / (1000 * 60 * 60 * 24));
                                return sum + days;
                              }
                              return sum;
                            }, 0);
                            avgDays = Math.round(totalDays / projectsWithStatus.length);
                          }
                          
                          return (
                            <div key={status} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                              <div className="text-sm font-medium text-gray-700 mb-1">{status}</div>
                              <div className="text-2xl font-bold text-gray-900">
                                {avgDays} <span className="text-sm font-normal text-gray-600">days</span>
                              </div>
                              <div className="text-xs text-gray-500 mt-1">
                                {projectsWithStatus.length} project(s) tracked
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                    )}
                  </div>
                  
                  {/* Team Workload - Collapsible */}
                  <div className="border border-gray-200 rounded-lg">
                    <button
                      onClick={() => setShowWorkload(!showWorkload)}
                      className="w-full flex justify-between items-center p-4 hover:bg-gray-50 transition"
                    >
                      <h3 className="text-lg font-semibold text-gray-900">Project Manager Workload</h3>
                      <span className="text-gray-500 text-xl">
                        {showWorkload ? 'â' : '+'}
                      </span>
                    </button>
                    {showWorkload && (
                    <div className="p-4 pt-0">
                      <div className="grid grid-cols-2 gap-4">
                        {projectManagers.map(pm => {
                          const pmProjects = projects.filter(p => p.projectManager === pm && p.status !== 'Shipped');
                        const statuses = {};
                        pmProjects.forEach(p => {
                          statuses[p.status] = (statuses[p.status] || 0) + 1;
                        });
                        
                        return (
                          <div key={pm} className="bg-gray-50 rounded-lg p-4 border border-gray-200">
                            <div className="flex justify-between items-start mb-3">
                              <div className="font-semibold text-gray-900">{pm}</div>
                              <div className="text-2xl font-bold text-blue-600">{pmProjects.length}</div>
                            </div>
                            <div className="space-y-1">
                              {Object.entries(statuses).map(([status, count]) => (
                                <div key={status} className="flex justify-between text-xs">
                                  <span className="text-gray-600">{status}</span>
                                  <span className="font-medium text-gray-900">{count}</span>
                                </div>
                              ))}
                              {pmProjects.length === 0 && (
                                <div className="text-xs text-gray-500">No active projects</div>
                              )}
                            </div>
                          </div>
                        );
                      })}
                      {projectManagers.length === 0 && (
                        <div className="col-span-2 text-center py-8 text-gray-500">
                          No project managers added yet
                        </div>
                      )}
                    </div>
                    </div>
                    )}
                  </div>
                </div>
              )}

              {/* Form Modal */}
              {showForm && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-900">
                          {editingProject ? "Edit Project" : "New Project"}
                        </h2>
                        <button
                          onClick={resetForm}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          <XIcon />
                        </button>
                      </div>

                      <form onSubmit={handleSubmit} className="space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Job Number *
                            </label>
                            <input
                              type="text"
                              name="jobNumber"
                              value={formData.jobNumber}
                              onChange={handleInputChange}
                              required
                              className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                formErrors.jobNumber ? 'border-red-500 bg-red-50' : 'border-gray-300'
                              }`}
                            />
                            {formErrors.jobNumber && (
                              <p className="text-xs text-red-600 mt-1">{formErrors.jobNumber}</p>
                            )}
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Date Assigned *
                            </label>
                            <input
                              type="date"
                              name="dateAssigned"
                              value={formData.dateAssigned}
                              onChange={handleInputChange}
                              required
                              className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                formErrors.dateAssigned ? 'border-red-500 bg-red-50' : 'border-gray-300'
                              }`}
                            />
                            {formErrors.dateAssigned && (
                              <p className="text-xs text-red-600 mt-1">{formErrors.dateAssigned}</p>
                            )}
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Job Title *
                          </label>
                          <input
                            type="text"
                            name="jobTitle"
                            value={formData.jobTitle}
                            onChange={handleInputChange}
                            required
                            className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                              formErrors.jobTitle ? 'border-red-500 bg-red-50' : 'border-gray-300'
                            }`}
                          />
                          {formErrors.jobTitle && (
                            <p className="text-xs text-red-600 mt-1">{formErrors.jobTitle}</p>
                          )}
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Customer *
                            </label>
                            <div className="relative">
                              <input
                                type="text"
                                name="customer"
                                value={formData.customer}
                                onChange={handleInputChange}
                                required
                                className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                  formErrors.customer ? 'border-red-500 bg-red-50' : 'border-gray-300'
                                }`}
                              />
                              <button
                                type="button"
                                onClick={() => openListManager("customer")}
                                className="absolute right-2 top-2 text-blue-600 hover:text-blue-800 text-sm font-medium"
                              >
                                Select â¼
                              </button>
                            </div>
                            {formErrors.customer && (
                              <p className="text-xs text-red-600 mt-1">{formErrors.customer}</p>
                            )}
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Project Manager *
                            </label>
                            <div className="relative">
                              <input
                                type="text"
                                name="projectManager"
                                value={formData.projectManager}
                                onChange={handleInputChange}
                                required
                                className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                                  formErrors.projectManager ? 'border-red-500 bg-red-50' : 'border-gray-300'
                                }`}
                              />
                              <button
                                type="button"
                                onClick={() => openListManager("pm")}
                                className="absolute right-2 top-2 text-blue-600 hover:text-blue-800 text-sm font-medium"
                              >
                                Select â¼
                              </button>
                            </div>
                            {formErrors.projectManager && (
                              <p className="text-xs text-red-600 mt-1">{formErrors.projectManager}</p>
                            )}
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Estimator
                            </label>
                            <div className="relative">
                              <input
                                type="text"
                                name="estimator"
                                value={formData.estimator}
                                onChange={handleInputChange}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                              <button
                                type="button"
                                onClick={() => openListManager("estimator")}
                                className="absolute right-2 top-2 text-blue-600 hover:text-blue-800 text-sm font-medium"
                              >
                                Select â¼
                              </button>
                            </div>
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Status *
                            </label>
                            <select
                              name="status"
                              value={formData.status}
                              onChange={handleInputChange}
                              required
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            >
                              {statusOptions.map((status) => (
                                <option key={status} value={status}>
                                  {status}
                                </option>
                              ))}
                            </select>
                          </div>
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Description
                          </label>
                          <textarea
                            name="description"
                            value={formData.description}
                            onChange={handleInputChange}
                            rows="3"
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-1">
                            Documents
                          </label>
                          <p className="text-xs text-gray-500 mb-2">
                            Upload PDFs, images, or any documents (Max 20MB per
                            file). Drag & drop files or use buttons below. Use "Combine PDFs" to merge multiple PDFs
                            before uploading.
                          </p>
                          <div className="flex gap-2 mb-3">
                            <button
                              type="button"
                              onClick={openMergePDFModal}
                              className="flex items-center gap-2 px-3 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition"
                            >
                              <MergeIcon />
                              Combine PDFs
                            </button>
                            <span className="text-gray-400 flex items-center">
                              or
                            </span>
                            <label
                              htmlFor="fileUpload"
                              className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition cursor-pointer"
                              title="Upload PDFs, images, documents, etc."
                            >
                              <UploadIcon />
                              Upload Files
                            </label>
                          </div>
                          <div 
                            className="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-blue-400 transition-colors bg-gray-50"
                            onDragOver={handleDragOver}
                            onDrop={handleDrop}
                          >
                            <input
                              type="file"
                              multiple
                              accept="*/*"
                              onChange={handleDocumentUpload}
                              className="hidden"
                              id="fileUpload"
                            />
                            {formData.documents.length === 0 ? (
                              <div className="text-center py-8">
                                <UploadIcon />
                                <p className="text-gray-500 text-sm mt-2">
                                  Drag and drop files here, or click "Upload Files" above
                                </p>
                                <p className="text-gray-400 text-xs mt-1">
                                  Supports all file types (PDFs, images, documents, etc.)
                                </p>
                              </div>
                            ) : null}
                            {formData.documents.length > 0 && (
                              <div className="mt-3 space-y-2">
                                {formData.documents.map((doc, index) => (
                                  <div
                                    key={index}
                                    className="flex items-center justify-between bg-white px-3 py-2 rounded border border-gray-200"
                                  >
                                    <span className="text-sm text-gray-700">
                                      {typeof doc === "string" ? doc : doc.name}
                                      {typeof doc === "object" && doc.size && (
                                        <span className="text-xs text-gray-500 ml-2">
                                          ({(doc.size / 1024).toFixed(1)} KB)
                                        </span>
                                      )}
                                    </span>
                                    <button
                                      type="button"
                                      onClick={() => removeDocument(index)}
                                      className="text-red-600 hover:text-red-700"
                                    >
                                      <XIcon />
                                    </button>
                                  </div>
                                ))}
                              </div>
                            )}
                          </div>
                        </div>

                        <div className="flex gap-3 pt-4">
                          <button
                            type="submit"
                            className="flex-1 flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                          >
                            <SaveIcon />
                            {editingProject ? "Update Project" : "Save Project"}
                          </button>
                          <button
                            type="button"
                            onClick={resetForm}
                            className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                          >
                            Cancel
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              )}

              {/* Status History Modal */}
              {showHistory && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6">
                      <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-900">
                          Status History - {showHistory.jobNumber}
                        </h2>
                        <button
                          onClick={() => setShowHistory(null)}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          <XIcon />
                        </button>
                      </div>

                      <div className="mb-4">
                        <h3 className="text-lg font-semibold text-gray-800">
                          {showHistory.jobTitle}
                        </h3>
                        <p className="text-gray-600">{showHistory.customer}</p>
                      </div>

                      <div className="space-y-4">
                        {showHistory.statusHistory &&
                        showHistory.statusHistory.length > 0 ? (
                          <div className="relative">
                            {/* Timeline line */}
                            <div className="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-300"></div>

                            {showHistory.statusHistory.map((entry, index) => (
                              <div
                                key={index}
                                className="relative flex gap-4 pb-8"
                              >
                                {/* Timeline dot */}
                                <div
                                  className={`relative z-10 flex items-center justify-center w-8 h-8 rounded-full ${
                                    statusColors[entry.status]
                                  } border-4 border-white shadow`}
                                >
                                  <div className="w-2 h-2 bg-current rounded-full"></div>
                                </div>

                                {/* Content */}
                                <div className="flex-1 bg-gray-50 rounded-lg p-4">
                                  <div className="flex justify-between items-start">
                                    <div>
                                      <span
                                        className={`inline-block px-3 py-1 rounded-full text-sm font-medium ${
                                          statusColors[entry.status]
                                        }`}
                                      >
                                        {entry.status}
                                      </span>
                                      {index ===
                                        showHistory.statusHistory.length -
                                          1 && (
                                        <span className="ml-2 text-xs text-green-600 font-semibold">
                                          CURRENT
                                        </span>
                                      )}
                                    </div>
                                    <div className="text-sm text-gray-600">
                                      {entry.date}
                                    </div>
                                  </div>

                                  {/* Status change description */}
                                  {entry.description && (
                                    <div className="mt-3 text-sm text-gray-700 bg-white p-3 rounded border-l-4 border-blue-400">
                                      <p className="font-medium text-gray-600 text-xs mb-1">
                                        Note:
                                      </p>
                                      <p className="whitespace-pre-wrap">
                                        {entry.description}
                                      </p>
                                    </div>
                                  )}

                                  {/* Calculate time spent in this status */}
                                  {index <
                                    showHistory.statusHistory.length - 1 && (
                                    <div className="mt-2 text-xs text-gray-500">
                                      Duration:{" "}
                                      {Math.floor(
                                        (new Date(
                                          showHistory.statusHistory[
                                            index + 1
                                          ].timestamp
                                        ) -
                                          new Date(entry.timestamp)) /
                                          (1000 * 60 * 60 * 24)
                                      )}{" "}
                                      days
                                    </div>
                                  )}
                                  {index ===
                                    showHistory.statusHistory.length - 1 && (
                                    <div className="mt-2 text-xs text-gray-500">
                                      Duration:{" "}
                                      {Math.floor(
                                        (new Date() -
                                          new Date(entry.timestamp)) /
                                          (1000 * 60 * 60 * 24)
                                      )}{" "}
                                      days (ongoing)
                                    </div>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : (
                          <div className="text-center py-8 text-gray-500">
                            No status history available
                          </div>
                        )}
                      </div>

                      <div className="mt-6 pt-4 border-t border-gray-200">
                        <div className="text-sm text-gray-600">
                          <strong>Total Time:</strong>{" "}
                          {showHistory.statusHistory &&
                          showHistory.statusHistory.length > 0
                            ? Math.floor(
                                (new Date() -
                                  new Date(
                                    showHistory.statusHistory[0].timestamp
                                  )) /
                                  (1000 * 60 * 60 * 24)
                              )
                            : 0}{" "}
                          days since project start
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Status Change Description Modal */}
              {showStatusChangeModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-lg w-full">
                    <div className="p-6">
                      <h2 className="text-2xl font-bold text-gray-900 mb-4">
                        Status Change Note
                      </h2>

                      <div className="mb-4">
                        <div className="flex items-center gap-3 mb-4">
                          <span
                            className={`px-3 py-1 rounded-full text-sm font-medium ${
                              statusColors[formData.status]
                            }`}
                          >
                            {formData.status}
                          </span>
                          <span className="text-gray-400">â</span>
                          <span
                            className={`px-3 py-1 rounded-full text-sm font-medium ${statusColors[pendingStatusChange]}`}
                          >
                            {pendingStatusChange}
                          </span>
                        </div>

                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Add a note about this status change (optional)
                        </label>
                        <textarea
                          value={statusChangeDescription}
                          onChange={(e) =>
                            setStatusChangeDescription(e.target.value)
                          }
                          placeholder="e.g., Customer requested revision to wall thickness, Changed to 72 inch ID, PM approved submittal drawings..."
                          rows="4"
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                        <p className="text-xs text-gray-500 mt-1">
                          This note will be saved in the status history for
                          reference
                        </p>
                      </div>

                      <div className="flex gap-3">
                        <button
                          onClick={confirmStatusChange}
                          className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                        >
                          Confirm Status Change
                        </button>
                        <button
                          onClick={cancelStatusChange}
                          className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Toast Notification */}
              {toast && (
                <div className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 animate-fade-in">
                  <div
                    className={`flex items-center gap-3 px-6 py-4 rounded-lg shadow-2xl border-2 ${
                      toast.type === "success"
                        ? "bg-green-50 border-green-500 text-green-800"
                        : toast.type === "error"
                        ? "bg-red-50 border-red-500 text-red-800"
                        : "bg-blue-50 border-blue-500 text-blue-800"
                    }`}
                  >
                    <div>
                      {toast.type === "success" && <CheckCircleIcon />}
                      {toast.type === "error" && <AlertCircleIcon />}
                      {toast.type === "info" && <InfoIcon />}
                    </div>
                    <span className="text-lg font-medium">{toast.message}</span>
                  </div>
                </div>
              )}
              
              {/* Undo Delete Toast */}
              {deletedProject && (
                <div className="fixed bottom-6 right-6 z-50 animate-fade-in">
                  <div className="flex items-center gap-3 px-6 py-4 rounded-lg shadow-2xl border-2 bg-gray-800 border-gray-700 text-white">
                    <span className="text-sm font-medium">Project deleted</span>
                    <button
                      onClick={undoDelete}
                      className="flex items-center gap-2 px-3 py-1.5 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition font-medium"
                    >
                      <UndoIcon />
                      Undo
                    </button>
                  </div>
                </div>
              )}

              {/* List Manager Modal */}
              {showListManager && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div className="p-6 border-b border-gray-200">
                      <div className="flex justify-between items-center">
                        <h2 className="text-xl font-bold text-gray-900">
                          Manage{" "}
                          {showListManager === "pm"
                            ? "Project Managers"
                            : showListManager === "customer"
                            ? "Customers"
                            : "Estimators"}
                        </h2>
                        <button
                          onClick={closeListManager}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          <XIcon />
                        </button>
                      </div>
                    </div>

                    <div className="p-6 flex-1 overflow-y-auto">
                      {/* Add/Edit Input */}
                      <div className="mb-4">
                        <div className="flex gap-2">
                          <input
                            type="text"
                            value={listManagerValue}
                            onChange={(e) =>
                              setListManagerValue(e.target.value)
                            }
                            onKeyPress={(e) => {
                              if (e.key === "Enter") {
                                editingListItem
                                  ? saveEditedItem()
                                  : addToList();
                              }
                            }}
                            placeholder={
                              editingListItem
                                ? "Edit item..."
                                : "Add new item..."
                            }
                            className="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                          />
                          {editingListItem ? (
                            <>
                              <button
                                onClick={saveEditedItem}
                                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                              >
                                Save
                              </button>
                              <button
                                onClick={() => {
                                  setEditingListItem(null);
                                  setListManagerValue("");
                                }}
                                className="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                              >
                                Cancel
                              </button>
                            </>
                          ) : (
                            <button
                              onClick={addToList}
                              className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
                            >
                              <PlusIcon />
                            </button>
                          )}
                        </div>
                      </div>

                      {/* List Items */}
                      <div className="space-y-2">
                        {(showListManager === "pm"
                          ? projectManagers
                          : showListManager === "customer"
                          ? customers
                          : estimators
                        )
                          .sort()
                          .map((item, index) => (
                            <div
                              key={index}
                              className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded hover:bg-gray-100 transition"
                            >
                              <button
                                onClick={() => selectFromList(item)}
                                className="flex-1 text-left text-gray-900 hover:text-blue-600 font-medium"
                              >
                                {item}
                              </button>
                              <div className="flex gap-1">
                                <button
                                  onClick={() => editListItem(item)}
                                  className="p-2 text-blue-600 hover:text-blue-800"
                                  title="Edit"
                                >
                                  <Edit2Icon />
                                </button>
                                <button
                                  onClick={() => deleteFromList(item)}
                                  className="p-2 text-red-600 hover:text-red-800"
                                  title="Delete"
                                >
                                  <Trash2Icon />
                                </button>
                              </div>
                            </div>
                          ))}
                      </div>

                      {(showListManager === "pm"
                        ? projectManagers
                        : showListManager === "customer"
                        ? customers
                        : estimators
                      ).length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                          No items yet. Add your first item above.
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* Customer Manager Modal */}
              {showCustomerManager && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-5xl w-full max-h-[90vh] overflow-hidden flex flex-col">
                    <div className="p-6 border-b border-gray-200">
                      <div className="flex justify-between items-center">
                        <h2 className="text-2xl font-bold text-gray-900">
                          Customer Management
                        </h2>
                        <button
                          onClick={closeCustomerManager}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          <XIcon />
                        </button>
                      </div>
                    </div>

                    <div className="flex flex-1 overflow-hidden">
                      {/* Customer List - Left Side */}
                      <div className="w-1/2 border-r border-gray-200 p-6 flex flex-col">
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">
                          Customers ({customerDatabase.length})
                        </h3>

                        {/* Search Bar */}
                        <div className="mb-4">
                          <input
                            type="text"
                            placeholder="Search customers..."
                            value={customerSearchQuery}
                            onChange={(e) => setCustomerSearchQuery(e.target.value)}
                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          />
                        </div>

                        {customerDatabase.length === 0 ? (
                          <div className="text-center py-12 text-gray-500">
                            <UsersIcon />
                            <p className="mt-2">
                              No customers yet. Add your first customer using
                              the form.
                            </p>
                          </div>
                        ) : (
                          <div className="space-y-2 overflow-y-auto flex-1 pr-2"
                            style={{ maxHeight: 'calc(80vh - 200px)' }}>
                            {customerDatabase
                              .filter((customer) => {
                                const searchLower = customerSearchQuery.toLowerCase();
                                return (
                                  customer.companyName.toLowerCase().includes(searchLower) ||
                                  (customer.contactPerson && customer.contactPerson.toLowerCase().includes(searchLower)) ||
                                  (customer.email && customer.email.toLowerCase().includes(searchLower)) ||
                                  (customer.phone && customer.phone.toLowerCase().includes(searchLower)) ||
                                  (customer.city && customer.city.toLowerCase().includes(searchLower))
                                );
                              })
                              .sort((a, b) =>
                                a.companyName.localeCompare(b.companyName)
                              )
                              .map((customer) => (
                                <div
                                  key={customer._id}
                                  className="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition"
                                >
                                  <div className="flex justify-between items-start mb-2">
                                    <div className="flex-1">
                                      <h4 className="font-semibold text-gray-900">
                                        {customer.companyName}
                                      </h4>
                                      {customer.contactPerson && (
                                        <p className="text-sm text-gray-600">
                                          {customer.contactPerson}
                                        </p>
                                      )}
                                    </div>
                                    <div className="flex gap-1">
                                      <button
                                        onClick={() =>
                                          selectCustomerFromDB(customer)
                                        }
                                        className="p-2 text-green-600 hover:text-green-800"
                                        title="Select for project"
                                      >
                                        <svg
                                          width="18"
                                          height="18"
                                          viewBox="0 0 24 24"
                                          fill="none"
                                          stroke="currentColor"
                                          strokeWidth="2"
                                          strokeLinecap="round"
                                          strokeLinejoin="round"
                                        >
                                          <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                                          <polyline points="22 4 12 14.01 9 11.01"></polyline>
                                        </svg>
                                      </button>
                                      <button
                                        onClick={() =>
                                          editCustomerRecord(customer)
                                        }
                                        className="p-2 text-blue-600 hover:text-blue-800"
                                        title="Edit"
                                      >
                                        <Edit2Icon />
                                      </button>
                                      <button
                                        onClick={() =>
                                          deleteCustomerRecord(customer._id)
                                        }
                                        className="p-2 text-red-600 hover:text-red-800"
                                        title="Delete"
                                      >
                                        <Trash2Icon />
                                      </button>
                                    </div>
                                  </div>
                                  <div className="text-xs text-gray-600 space-y-1">
                                    {customer.email && (
                                      <div>ð§ {customer.email}</div>
                                    )}
                                    {customer.phone && (
                                      <div>ð {customer.phone}</div>
                                    )}
                                    {customer.address && (
                                      <div>
                                        ð {customer.address}
                                        {customer.city && `, ${customer.city}`}
                                        {customer.state &&
                                          `, ${customer.state}`}{" "}
                                        {customer.zip}
                                      </div>
                                    )}
                                  </div>
                                </div>
                              ))}
                          </div>
                        )}
                      </div>

                      {/* Customer Form - Right Side */}
                      <div className="w-1/2 overflow-y-auto p-6">
                        <h3 className="text-lg font-semibold text-gray-900 mb-4">
                          {editingCustomer
                            ? "Edit Customer"
                            : "Add New Customer"}
                        </h3>

                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Company Name *
                            </label>
                            <input
                              type="text"
                              name="companyName"
                              value={customerFormData.companyName}
                              onChange={handleCustomerFormChange}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Contact Person
                            </label>
                            <input
                              type="text"
                              name="contactPerson"
                              value={customerFormData.contactPerson}
                              onChange={handleCustomerFormChange}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>

                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                Email
                              </label>
                              <input
                                type="email"
                                name="email"
                                value={customerFormData.email}
                                onChange={handleCustomerFormChange}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                Phone
                              </label>
                              <input
                                type="tel"
                                name="phone"
                                value={customerFormData.phone}
                                onChange={handleCustomerFormChange}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                            </div>
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Address
                            </label>
                            <input
                              type="text"
                              name="address"
                              value={customerFormData.address}
                              onChange={handleCustomerFormChange}
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>

                          <div className="grid grid-cols-3 gap-4">
                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                City
                              </label>
                              <input
                                type="text"
                                name="city"
                                value={customerFormData.city}
                                onChange={handleCustomerFormChange}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                State
                              </label>
                              <input
                                type="text"
                                name="state"
                                value={customerFormData.state}
                                onChange={handleCustomerFormChange}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                            </div>

                            <div>
                              <label className="block text-sm font-medium text-gray-700 mb-1">
                                ZIP
                              </label>
                              <input
                                type="text"
                                name="zip"
                                value={customerFormData.zip}
                                onChange={handleCustomerFormChange}
                                className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              />
                            </div>
                          </div>

                          <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">
                              Notes
                            </label>
                            <textarea
                              name="notes"
                              value={customerFormData.notes}
                              onChange={handleCustomerFormChange}
                              rows="3"
                              className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            />
                          </div>

                          <div className="flex gap-3 pt-4">
                            <button
                              onClick={saveCustomer}
                              className="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                            >
                              {editingCustomer
                                ? "Update Customer"
                                : "Add Customer"}
                            </button>
                            {editingCustomer && (
                              <button
                                onClick={() => {
                                  setEditingCustomer(null);
                                  setCustomerFormData({
                                    companyName: "",
                                    contactPerson: "",
                                    email: "",
                                    phone: "",
                                    address: "",
                                    city: "",
                                    state: "",
                                    zip: "",
                                    notes: "",
                                  });
                                }}
                                className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                              >
                                Cancel Edit
                              </button>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Merge PDF Modal */}
              {showMergePDFModal && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden flex flex-col">
                    <div className="p-6 border-b border-gray-200">
                      <div className="flex justify-between items-center">
                        <h2 className="text-xl font-bold text-gray-900">
                          Combine PDF Files
                        </h2>
                        <button
                          onClick={closeMergePDFModal}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          <XIcon />
                        </button>
                      </div>
                    </div>

                    <div className="p-6 flex-1 overflow-y-auto">
                      {/* File Selection */}
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Select PDF files to combine (in order)
                        </label>
                        <input
                          type="file"
                          accept=".pdf"
                          multiple
                          onChange={handlePDFFilesSelect}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>

                      {/* File Name */}
                      <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700 mb-2">
                          Combined file name
                        </label>
                        <input
                          type="text"
                          value={mergedFileName}
                          onChange={(e) => setMergedFileName(e.target.value)}
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                      </div>

                      {/* File List */}
                      {pdfFilesToMerge.length > 0 && (
                        <div>
                          <label className="block text-sm font-medium text-gray-700 mb-2">
                            Files to merge ({pdfFilesToMerge.length})
                          </label>
                          <div className="space-y-2">
                            {pdfFilesToMerge.map((file, index) => (
                              <div
                                key={index}
                                className="flex items-center justify-between bg-gray-50 px-3 py-2 rounded border border-gray-200"
                              >
                                <div className="flex items-center gap-2">
                                  <span className="text-sm font-medium text-gray-500">
                                    #{index + 1}
                                  </span>
                                  <FileTextIcon />
                                  <div>
                                    <p className="text-sm font-medium text-gray-900">
                                      {file.name}
                                    </p>
                                    <p className="text-xs text-gray-500">
                                      {(file.size / 1024).toFixed(1)} KB
                                    </p>
                                  </div>
                                </div>
                                <div className="flex gap-1">
                                  <button
                                    onClick={() => movePDFUp(index)}
                                    disabled={index === 0}
                                    className="p-2 text-gray-600 hover:text-gray-800 disabled:opacity-30 disabled:cursor-not-allowed"
                                    title="Move up"
                                  >
                                    <ArrowUpIcon />
                                  </button>
                                  <button
                                    onClick={() => movePDFDown(index)}
                                    disabled={
                                      index === pdfFilesToMerge.length - 1
                                    }
                                    className="p-2 text-gray-600 hover:text-gray-800 disabled:opacity-30 disabled:cursor-not-allowed"
                                    title="Move down"
                                  >
                                    <ArrowDownIcon />
                                  </button>
                                  <button
                                    onClick={() => removePDFFromMerge(index)}
                                    className="p-2 text-red-600 hover:text-red-800"
                                    title="Remove"
                                  >
                                    <Trash2Icon />
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}

                      {pdfFilesToMerge.length === 0 && (
                        <div className="text-center py-8 text-gray-500">
                          No PDF files selected. Please select at least 2 PDF
                          files to merge.
                        </div>
                      )}
                    </div>

                    <div className="p-6 border-t border-gray-200">
                      <div className="flex gap-3">
                        <button
                          onClick={mergePDFs}
                          disabled={pdfFilesToMerge.length < 2}
                          className="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                          Merge PDFs
                        </button>
                        <button
                          onClick={closeMergePDFModal}
                          className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Delete Confirmation Modal */}
              {deleteConfirmation && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                    <div className="p-6">
                      <div className="flex items-center gap-4 mb-4">
                        <div className="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                          <AlertCircleIcon />
                        </div>
                        <div>
                          <h2 className="text-xl font-bold text-gray-900">
                            Delete Project?
                          </h2>
                          <p className="text-sm text-gray-600 mt-1">
                            This action cannot be undone
                          </p>
                        </div>
                      </div>

                      <div className="bg-gray-50 rounded-lg p-4 mb-6">
                        <p className="text-sm font-medium text-gray-700">
                          <strong>Job:</strong> {deleteConfirmation.jobNumber}
                        </p>
                        <p className="text-sm text-gray-700 mt-1">
                          <strong>Title:</strong> {deleteConfirmation.jobTitle}
                        </p>
                        <p className="text-sm text-gray-700 mt-1">
                          <strong>Customer:</strong>{" "}
                          {deleteConfirmation.customer}
                        </p>
                      </div>

                      <div className="flex gap-3">
                        <button
                          onClick={confirmDelete}
                          className="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-medium"
                        >
                          Yes, Delete Project
                        </button>
                        <button
                          onClick={cancelDelete}
                          className="flex-1 px-4 py-2 border-2 border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium"
                        >
                          Cancel
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Project Details Modal */}
              {showDetails && (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <div className="p-6">
                      <div className="flex justify-between items-center mb-6">
                        <div>
                          <h2 className="text-3xl font-bold text-gray-900">
                            {showDetails.jobNumber}
                          </h2>
                          <p className="text-xl text-gray-700 mt-1">
                            {showDetails.jobTitle}
                          </p>
                        </div>
                        <button
                          onClick={() => setShowDetails(null)}
                          className="text-gray-500 hover:text-gray-700"
                        >
                          <XIcon />
                        </button>
                      </div>

                      {/* Current Status Badge */}
                      <div className="mb-6">
                        <span
                          className={`inline-block px-4 py-2 rounded-full text-sm font-medium ${
                            statusColors[showDetails.status]
                          }`}
                        >
                          {showDetails.status}
                        </span>
                      </div>

                      {/* Project Information Grid */}
                      <div className="grid grid-cols-2 gap-6 mb-6">
                        <div className="bg-gray-50 rounded-lg p-4">
                          <h3 className="text-sm font-semibold text-gray-600 uppercase mb-2">
                            Customer
                          </h3>
                          <p className="text-lg text-gray-900">
                            {showDetails.customer}
                          </p>
                        </div>

                        <div className="bg-gray-50 rounded-lg p-4">
                          <h3 className="text-sm font-semibold text-gray-600 uppercase mb-2">
                            Date Assigned
                          </h3>
                          <p className="text-lg text-gray-900">
                            {showDetails.dateAssigned}
                          </p>
                        </div>

                        <div className="bg-gray-50 rounded-lg p-4">
                          <h3 className="text-sm font-semibold text-gray-600 uppercase mb-2">
                            Project Manager
                          </h3>
                          <p className="text-lg text-gray-900">
                            {showDetails.projectManager}
                          </p>
                        </div>

                        <div className="bg-gray-50 rounded-lg p-4">
                          <h3 className="text-sm font-semibold text-gray-600 uppercase mb-2">
                            Estimator
                          </h3>
                          <p className="text-lg text-gray-900">
                            {showDetails.estimator || "N/A"}
                          </p>
                        </div>
                      </div>

                      {/* Description */}
                      {showDetails.description && (
                        <div className="mb-6">
                          <h3 className="text-sm font-semibold text-gray-600 uppercase mb-2">
                            Description
                          </h3>
                          <div className="bg-gray-50 rounded-lg p-4">
                            <p className="text-gray-900 whitespace-pre-wrap">
                              {showDetails.description}
                            </p>
                          </div>
                        </div>
                      )}

                      {/* Documents */}
                      {showDetails.documents &&
                        showDetails.documents.length > 0 && (
                          <div className="mb-6">
                            <h3 className="text-sm font-semibold text-gray-600 uppercase mb-2">
                              Documents
                            </h3>
                            <div className="bg-gray-50 rounded-lg p-4">
                              <div className="space-y-2">
                                {showDetails.documents.map((doc, index) => (
                                  <div
                                    key={index}
                                    className="flex items-center justify-between bg-white px-4 py-3 rounded border border-gray-200 hover:border-blue-400 transition"
                                  >
                                    <div className="flex items-center gap-3">
                                      <FileTextIcon />
                                      <div>
                                        <p className="text-sm font-medium text-gray-900">
                                          {typeof doc === "string"
                                            ? doc
                                            : doc.name}
                                        </p>
                                        {typeof doc === "object" &&
                                          doc.size && (
                                            <p className="text-xs text-gray-500">
                                              {(doc.size / 1024).toFixed(1)} KB
                                            </p>
                                          )}
                                      </div>
                                    </div>
                                    {typeof doc === "object" && doc.data && (
                                      <button
                                        onClick={() =>
                                          handleDownloadDocument(doc)
                                        }
                                        className="flex items-center gap-1 text-blue-600 hover:text-blue-800 text-sm font-medium"
                                      >
                                        <DownloadIcon />
                                        Download
                                      </button>
                                    )}
                                  </div>
                                ))}
                              </div>
                            </div>
                          </div>
                        )}

                      {/* Status History Summary */}
                      {showDetails.statusHistory &&
                        showDetails.statusHistory.length > 0 && (
                          <div className="mb-6">
                            <div className="flex items-center justify-between mb-2">
                              <h3 className="text-sm font-semibold text-gray-600 uppercase">
                                Status History
                              </h3>
                              <button
                                onClick={() => {
                                  setShowDetails(null);
                                  setShowHistory(showDetails);
                                }}
                                className="text-sm text-blue-600 hover:text-blue-800 font-medium"
                              >
                                View Full History
                              </button>
                            </div>
                            <div className="bg-gray-50 rounded-lg p-4">
                              <div className="space-y-3">
                                {showDetails.statusHistory
                                  .slice(-3)
                                  .reverse()
                                  .map((entry, index) => (
                                    <div
                                      key={index}
                                      className="bg-white p-3 rounded border border-gray-200"
                                    >
                                      <div className="flex justify-between items-center mb-2">
                                        <span
                                          className={`px-3 py-1 rounded-full text-xs font-medium ${
                                            statusColors[entry.status]
                                          }`}
                                        >
                                          {entry.status}
                                        </span>
                                        <span className="text-sm text-gray-600">
                                          {entry.date}
                                        </span>
                                      </div>
                                      {entry.description && (
                                        <p className="text-sm text-gray-700 mt-2 pl-2 border-l-2 border-blue-400">
                                          {entry.description}
                                        </p>
                                      )}
                                    </div>
                                  ))}
                              </div>
                              {showDetails.statusHistory.length > 3 && (
                                <p className="text-xs text-gray-500 mt-2">
                                  Showing last 3 of{" "}
                                  {showDetails.statusHistory.length} status
                                  changes
                                </p>
                              )}
                            </div>
                          </div>
                        )}

                      {/* Project Timeline */}
                      {showDetails.statusHistory &&
                        showDetails.statusHistory.length > 0 && (
                          <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                            <div className="flex items-center justify-between">
                              <div>
                                <p className="text-sm text-gray-600">
                                  Project Duration
                                </p>
                                <p className="text-2xl font-bold text-gray-900">
                                  {Math.floor(
                                    (new Date() -
                                      new Date(
                                        showDetails.statusHistory[0].timestamp
                                      )) /
                                      (1000 * 60 * 60 * 24)
                                  )}{" "}
                                  days
                                </p>
                              </div>
                              <div className="text-right">
                                <p className="text-sm text-gray-600">
                                  Status Changes
                                </p>
                                <p className="text-2xl font-bold text-gray-900">
                                  {showDetails.statusHistory.length}
                                </p>
                              </div>
                            </div>
                          </div>
                        )}

                      {/* Action Buttons */}
                      <div className="flex gap-3 mt-6 pt-6 border-t border-gray-200">
                        <button
                          onClick={() => {
                            setShowDetails(null);
                            handleEdit(showDetails);
                          }}
                          className="flex-1 flex items-center justify-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                        >
                          <Edit2Icon />
                          Edit Project
                        </button>
                        <button
                          onClick={() => setShowDetails(null)}
                          className="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition"
                        >
                          Close
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Projects List - Hidden in Dashboard View */}
              {!showDashboard && (
              <div className="bg-white rounded-lg shadow-sm">
                {selectedProjects.length > 0 && (
                  <div className="px-6 py-3 bg-blue-50 border-b border-blue-200">
                    <p className="text-sm text-blue-800">
                      <strong>{selectedProjects.length}</strong> of{" "}
                      <strong>{filteredProjects.length}</strong> project(s)
                      selected
                    </p>
                  </div>
                )}
                {filteredProjects.length === 0 ? (
                  <div className="p-12 text-center">
                    <p className="text-gray-500 text-lg">
                      No projects found. Click "New Project" to get started!
                    </p>
                  </div>
                ) : (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead className="bg-gray-50 border-b border-gray-200">
                        <tr>
                          <th className="px-4 py-3 text-left">
                            <input
                              type="checkbox"
                              checked={
                                filteredProjects.length > 0 &&
                                selectedProjects.length ===
                                  filteredProjects.length
                              }
                              onChange={toggleSelectAll}
                              className="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                              title="Select all"
                            />
                          </th>
                          <th 
                            className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                            onClick={() => handleSort('jobNumber')}
                          >
                            <div className="flex items-center gap-1">
                              Job #
                              {sortField === 'jobNumber' && (
                                <span className="text-blue-600">
                                  {sortDirection === 'asc' ? 'â' : 'â'}
                                </span>
                              )}
                            </div>
                          </th>
                          <th 
                            className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                            onClick={() => handleSort('jobTitle')}
                          >
                            <div className="flex items-center gap-1">
                              Title
                              {sortField === 'jobTitle' && (
                                <span className="text-blue-600">
                                  {sortDirection === 'asc' ? 'â' : 'â'}
                                </span>
                              )}
                            </div>
                          </th>
                          <th 
                            className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                            onClick={() => handleSort('customer')}
                          >
                            <div className="flex items-center gap-1">
                              Customer
                              {sortField === 'customer' && (
                                <span className="text-blue-600">
                                  {sortDirection === 'asc' ? 'â' : 'â'}
                                </span>
                              )}
                            </div>
                          </th>
                          <th 
                            className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                            onClick={() => handleSort('projectManager')}
                          >
                            <div className="flex items-center gap-1">
                              PM
                              {sortField === 'projectManager' && (
                                <span className="text-blue-600">
                                  {sortDirection === 'asc' ? 'â' : 'â'}
                                </span>
                              )}
                            </div>
                          </th>
                          <th 
                            className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                            onClick={() => handleSort('dateAssigned')}
                          >
                            <div className="flex items-center gap-1">
                              Date Assigned
                              {sortField === 'dateAssigned' && (
                                <span className="text-blue-600">
                                  {sortDirection === 'asc' ? 'â' : 'â'}
                                </span>
                              )}
                            </div>
                          </th>
                          <th 
                            className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider cursor-pointer hover:bg-gray-100"
                            onClick={() => handleSort('status')}
                          >
                            <div className="flex items-center gap-1">
                              Status
                              {sortField === 'status' && (
                                <span className="text-blue-600">
                                  {sortDirection === 'asc' ? 'â' : 'â'}
                                </span>
                              )}
                            </div>
                          </th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">
                            Actions
                          </th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {filteredProjects.map((project) => (
                          <tr key={project._id} className="hover:bg-gray-50">
                            <td className="px-4 py-4 whitespace-nowrap">
                              <input
                                type="checkbox"
                                checked={selectedProjects.includes(project._id)}
                                onChange={() =>
                                  toggleProjectSelection(project._id)
                                }
                                className="w-4 h-4 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                              />
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                              {project.jobNumber}
                            </td>
                            <td className="px-6 py-4 text-sm text-gray-900">
                              {project.jobTitle}
                            </td>
                            <td className="px-6 py-4 text-sm text-gray-900">
                              {project.customer}
                            </td>
                            <td className="px-6 py-4 text-sm text-gray-900">
                              {project.projectManager}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                              {project.dateAssigned}
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap">
                              <span
                                className={`px-3 py-1 rounded-full text-xs font-medium ${
                                  statusColors[project.status]
                                }`}
                              >
                                {project.status}
                              </span>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                              <div className="flex gap-2">
                                <button
                                  onClick={() => setShowDetails(project)}
                                  className="text-green-600 hover:text-green-800"
                                  title="View Details"
                                >
                                  <EyeIcon />
                                </button>
                                <button
                                  onClick={() => setShowHistory(project)}
                                  className="text-purple-600 hover:text-purple-800"
                                  title="View Status History"
                                >
                                  <ClockIcon />
                                </button>
                                <button
                                  onClick={() => handleEdit(project)}
                                  className="text-blue-600 hover:text-blue-800"
                                  title="Edit"
                                >
                                  <Edit2Icon />
                                </button>
                                <button
                                  onClick={() => handleDelete(project)}
                                  className="text-red-600 hover:text-red-800"
                                  title="Delete"
                                >
                                  <Trash2Icon />
                                </button>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
              )}

              {/* Summary Stats - Only show when searching */}
              {searchTerm && filteredProjects.length > 0 && !showDashboard && (
                <div className="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                  <h3 className="text-sm font-semibold text-gray-700 mb-3">
                    Search Results for "{searchTerm}"
                  </h3>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="bg-white rounded-lg shadow-sm p-4">
                      <div className="text-2xl font-bold text-gray-900">
                        {filteredProjects.length}
                      </div>
                      <div className="text-sm text-gray-600">
                        Total Projects
                      </div>
                    </div>
                    <div className="bg-white rounded-lg shadow-sm p-4">
                      <div className="text-2xl font-bold text-orange-600">
                        {
                          filteredProjects.filter(
                            (p) => p.status === "Revisions Needed"
                          ).length
                        }
                      </div>
                      <div className="text-sm text-gray-600">
                        Revisions Needed
                      </div>
                    </div>
                    <div className="bg-white rounded-lg shadow-sm p-4">
                      <div className="text-2xl font-bold text-purple-600">
                        {
                          filteredProjects.filter(
                            (p) =>
                              p.status === "Production Drawings" ||
                              p.status === "Production"
                          ).length
                        }
                      </div>
                      <div className="text-sm text-gray-600">In Production</div>
                    </div>
                    <div className="bg-white rounded-lg shadow-sm p-4">
                      <div className="text-2xl font-bold text-green-600">
                        {
                          filteredProjects.filter((p) => p.status === "Shipped")
                            .length
                        }
                      </div>
                      <div className="text-sm text-gray-600">Shipped</div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      };

      ReactDOM.render(<CADWorkflowTracker />, document.getElementById("root"));
    </script>
  </body>
</html>
